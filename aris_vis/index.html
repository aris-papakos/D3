<!DOCTYPE html>
<html>
  <head>
    <link rel='stylesheet' href="main.css">
    <meta charset="utf-8">
    <script type="text/javascript" src="d3/d3.min.js"></script>
    <title>Stream Graph</title>
  </head>

<body>
<script>
var w = 800;
 var h = 450;
 var margin = {
      top: 58,
      bottom: 100,
      left: 80,
      right:40
 };
var width = w - margin.right- margin.left;
var height = h- margin.top - margin.bottom;

var crime_types =  ['Anti-social behaviour','Bicycle theft',"Burglary",
                    "Criminal damage and arson","Drugs","Other crime","Other theft",
                    "Possession of weapons","Public order","Robbery", "Shoplifting",
                    "Theft from the person","Vehicle crime","Violence and sexual offences"];

var z = d3.scaleLinear()
          .range(["#51D0D7", "#31B5BB"]);

var x = d3.scaleTime()
          .range([0,width-5]);

var y = d3.scaleLinear()
          .range([height-20,0]);

var xAxis = d3.axisBottom()
              .scale(x)
              .ticks(5);

var yAxis = d3.axisLeft()
              .scale(y)
              .ticks(5);
var yAxis_right = d3.axisRight()
                    .scale(y)
                    .ticks(5);
var svg = d3.select('body').append("svg")
                           .attr('id', 'chart')
                           .attr('height',h)
                           .attr('width', w);

var stream = svg.append("g")
                 .classed("display",true)
                 .attr('transform', 'translate('+margin.left+','+margin.top+')');


var stack = d3.stack()
              .keys(crime_types)
              // .order(d3.stackOrderNone);
              .order(d3.stackOrderAscending)
              // .offset(d3.stackOffsetWiggle);
              .offset(d3.stackOffsetWiggle);


// LOAD CSV DATA
// d3.csv("aris_dataset.csv", function(crime_rows) {
// LOAD JSON data
d3.json("playground.json", function(crime_rows) {
/////////////////////////////////////////////////////////////////////////////
    // Data preprocessing
    var expensesTotal = d3.nest()
        .key(function(d) { return d.Month; })
        .key(function(d) { return d.CrimeType; })
        .rollup(function(v) { return v.length;
                            })
        .object(crime_rows);

  console.log(expensesTotal);

    // put label inside as key and return an array
    var data = Object.keys(expensesTotal).map(function(key) {
        expensesTotal[key].Month = key;

        return expensesTotal[key];
    });

    console.log(data);
    // TODO get crime types from labels??


    // TODO add data.columns
    data.columns = crime_types;



    console.log(data);



//////////////////////////////////////////////////////////////////////////

    //Date parse
    var dataParser = d3.timeParse("%Y-%m");
    data.forEach(function(d) {
                          d.Month = dataParser(d.Month);
                          // d.count = +d.count;
                        });
    console.log(data);
//////////////////////////////////////////////////////////////////////////
    var maxDateVal = d3.sum(data, function(d){
                                var vals = d3.keys(d).map(function(key){ return key !== 'Month' ? d[key] : 0 });
                                return d3.max(vals);
                              });
    console.log(maxDateVal);

    var series = stack(data);
    console.log(series);

    x.domain(d3.extent(data, function (d) {
                             return d.Month;
                     }));

    y.domain([0,2000]);// todo----see it

    var xAxis = d3.axisBottom()
                  .scale(x);


    var area = d3.area()
        .x(function(d) {
          return x(d.data.Month);
         })
        .y0(function(d) { return y(d[0]); })
        .y1(function(d) { return y(d[1]); })
        .curve(d3.curveCardinal);
        // .curve(d3.curveBasis);

    function plot(params) {
              // create x axis

              this.append("g")
                  .classed("x axis", true)
                  .attr('transform', 'translate(0,'+height+')')
                  .call(params.axis.x);

              // create y axis left
              this.append("g")
                  .classed("y axis", true)
                  .attr('transform', 'translate('+-5+','+20+')')
                  .call(params.axis.y);

              // create y axis right
              this.append("g")
                  .classed("y axis2", true)
                  .attr('transform', 'translate('+width+','+20+')')
                  .call(params.axis.y2);

              // enter
              this.selectAll(".layer")
                  .data(params.layer)
                  .enter()
                    .append("path")
                    .classed("layer",true);



             //update
             this.selectAll(".layer")
                 .attr("d", area)
                 .style("fill",function(d, i) { return z(i); })
                 .style("stroke", "black")
                 .style("opacity",0.5)
                 .on("mouseover", function(d,i){
                       d3.select(this)
                         .style("opacity",1)
                 })
                 .on("mouseout",function(d,i){
                   d3.select(this)
                       //.classed("highlight", true)
                      .transition()
                       .style("opacity", 0.5);

                 });
             //exit()
             this.selectAll(".layer")
                .data(params.layer)
                .exit()
                .remove();

      }
      plot.call(stream,{
                  data:data,
                  axis:{
                    x: xAxis,
                    y: yAxis,
                   y2: yAxis_right
                 },
                 layer:series

                   });
});

    </script>
  </body>
</html>
