<!DOCTYPE html>
<html>
  <head>
    <link rel='stylesheet' href="main3.css">
    <meta charset="utf-8">
    <script type="text/javascript" src="d3/d3.min.js"></script>
    <title>Stream Graph</title>
  </head>

<body>
<script>
var w = 1000;
 var h = 450;
 var margin = {
      top: 58,
      bottom: 80,
      left: 100,
      right:80
 };
var width = w - margin.right- margin.left;
var height = h- margin.top - margin.bottom;


var MONTH_NAMES = ["January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];



// var z = d3.scaleLinear()
//           // .range(["#51D0D7", "#31B5BB"]);
//           .range(["#51D0D7", "#31B5BB"]);
var z= d3.scaleOrdinal(d3.schemeCategory20c);
// var z= d3.scaleOrdinal()
//          .range(["#B30000", "#E34A33", "#FC8D59", "#FDBB84", "#FDD49E", "#FEF0D9"]);

var x = d3.scaleTime()
          .range([0,width-5]);

var y = d3.scaleLinear()
          .range([height-20,0]);

var xAxis = d3.axisBottom()
              .scale(x)
              .ticks(10);

var yAxis = d3.axisLeft()
              .scale(y)
              .ticks(5);
var yAxis_right = d3.axisRight()
                    .scale(y)
                    .ticks(5);
var svg = d3.select('body').append("svg")
                           .attr('id', 'chart')
                           .attr('height',h)
                           .attr('width', w);

var stream = svg.append("g")
                 .classed("display",true)
                 .attr('transform', 'translate('+margin.left+','+margin.top+')');





// LOAD CSV DATA
// d3.csv("aris_dataset.csv", function(crime_rows) {

// LOAD JSON data
d3.json("playground.json", function(crime_rows) {
/////////////////////////////////////////////////////////////////////////////

      // console.log(crime_rows);

      var nested_data = d3.nest()
        .key(function(d) { return d.CrimeType; })
        .entries(crime_rows);

      // console.log(nested_data);

      //crime categories
      var crime_types = []

      nested_data.forEach(function(key) {
        crime_types.push(key.key)
      });
      // console.log(crime_types);

    // Data preprocessing
    var expensesTotal = d3.nest()
        .key(function(d) { return d.Month; })
        .key(function(d) { return d.CrimeType; })
        .rollup(function(v) { return v.length;
                            })
        .object(crime_rows);

   // console.log(expensesTotal);

    // put label inside as key and return an array
    var data = Object.keys(expensesTotal).map(function(key) {
        expensesTotal[key].Month = key;

        return expensesTotal[key];
    });


    data.columns = crime_types;

    // console.log(data);

//////////////////////////////////////////////////////////////////////////

    //Date parse
    var dataParser = d3.timeParse("%Y-%m");
    data.forEach(function(d) {
                          d.Month = dataParser(d.Month);
                          // d.count = +d.count;
                        });
    // console.log(data);

//////////////////////////////////////////////////////////////////////////

    var maxDateVal = d3.sum(data, function(d){
                                var vals = d3.keys(d).map(function(key){ return key !== 'Month' ? d[key] : 0 });
                                return d3.max(vals);
                              });
    var maxY= d3.max(data, function(d){
                                var vals = d3.keys(d).map(function(key){ return key !== 'Month' ? d[key] : 0 });
                                return d3.sum(vals);
                              });
    // console.log(maxDateVal);
    var stack = d3.stack()
                  .keys(crime_types)
                  .order(d3.stackOrderNone)
                  // .offset(d3.stackOffsetWiggle);
                  //.order(d3.stackOrderAscending)
                  .offset(d3.stackOffsetWiggle);

    var series = stack(data);
    console.log(series);

    x.domain(d3.extent(data, function (d) {
                             return d.Month;
                     }));

    y.domain([0,maxY+100]);// todo----see it---make it DYNAMIC

    var xAxis = d3.axisBottom()
                  .scale(x);


    var area = d3.area()
        .x(function(d) {
          return x(d.data.Month);
         })
        .y0(function(d) { return y(d[0]); })
        .y1(function(d) { return y(d[1]); })
        .curve(d3.curveCardinal);
        // .curve(d3.curveBasis);


   function drawAxis(params){

       // create x axis
       this.append("g")
           .classed("axis x", true)
           .attr('transform', 'translate(0,'+height+')')
           .call(params.axis.x);

       // create y axis left
       this.append("g")
           .classed("axis y", true)
           .attr('transform', 'translate('+-5+','+20+')')
           .call(params.axis.y);

       // create y axis right
       this.append("g")
           .classed("y axis2", true)
           .attr('transform', 'translate('+width+','+20+')')
           .call(params.axis.y2);

      //label of x axis
       this.select(".axis.x")
    			 .append("text")
           .style("fill","black")
    			 .classed("x axis-label", true)
           .style("text-anchor", "middle")
    			 .attr("transform", "translate(" + width/1.9 + "," + 48 + ")")
    			 .text("Months");

       this.select(".axis.y")
     			 .append("text")
           .style("fill","black")
     			 .classed("y axis-label", true)
     			 .attr("transform", "translate(" + -56 + "," + height/4 +  ") rotate(-90)")
     			 .text("Number of Crimes")

      this.append("g")
          .append("text")
          .classed("chart-header",true)
          .attr("transform", "translate(0,0)")
          .text("");


   }



    function plot(params) {
              drawAxis.call(this, params);

              // enter
              this.selectAll(".layer")
                  .data(params.layer)
                  .enter()
                    .append("path")
                    .classed("layer",true);

             //update
             this.selectAll(".layer")
                 .attr("d", area)
                 .style("fill",function(d, i) { return z(i); })
                 .style("stroke", "black")
                 .style("opacity",0.5)
                 .on("mousemove", function(d,i){
                   console.log(d);
                      mousex = d3.mouse(this);
                      mousex = mousex[0];
                      var invertedx = x.invert(mousex);
                      invertedx = MONTH_NAMES[invertedx.getMonth()] +'-'+ invertedx.getFullYear();
                      var selected = (d.values);
                      var str = d.key+','+'   '+'Date:  '+ invertedx;
                      d3.select(".chart-header")
                        .text(str);

                       d3.select(this)
                         .style("opacity",1)
                         .style();
                 })

                 .on("mouseout",function(d,i){
                   d3.select(this)
                     .transition()
                     .style("opacity", 0.5);
                 });
             //exit()
             this.selectAll(".layer")
                 .data(params.layer)
                 .exit()
                 .remove();

      }

      //CALL function
      plot.call(stream,{
                  data:data,
                  axis:{
                    x: xAxis,
                    y: yAxis,
                   y2: yAxis_right
                 },
                 layer:series

                   });
});

    </script>
  </body>
</html>
